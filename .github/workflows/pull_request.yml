# SPDX-License-Identifier: Apache-2.0
# Copyright 2022 Intel Corporation
name: Pull Request

on: [pull_request]

concurrency:
  group: ${{ github.event.pull_request.number }}
  cancel-in-progress: true
  

jobs:
  build:
    #env:
      # DOCKER_REGISTRY: "docker.io/"
      # DOCKER_REPOSITORY: "badhrinathpa/"
      # VERSION: "PR-${{ github.event.pull_request.number }}"
    runs-on: self-hosted
    steps:
      # Checkout and build
      - uses: actions/checkout@v3
      - name: Build Docker image
        run: |
          make docker-build
      # Format the code
      - name: Go Format
        run: |
          make fmt

      - name: Show all CI changes
        run: |
          git --no-pager diff

      # Build again and commit
      - name: Build Docker image after format
        run: |
          make docker-build
      - name: Update PR with changes
        uses: gr2m/create-or-update-pull-request-action@v1.x
        env:
          GITHUB_TOKEN: ${{ github.token }}
        with:
          body: |
            Updated with changes from CI
          branch: ${{ github.event.pull_request.head.ref }}
          author: "Github Actions <actions@github>"
          commit-message: "Actions: Updated with changes from CI"
      - name: Run AIAB
        run: |
          sudo apt-get update
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod a+x /usr/local/bin/yq
          make docker-build
          rm -rf $HOME/aether-in-a-box
          rm -rf $HOME/cord
          cd $HOME
          git clone "https://gerrit.opencord.org/aether-in-a-box"
          mkdir $HOME/cord
          cd $HOME/cord
          git clone "https://gerrit.opencord.org/sdcore-helm-charts"
          git clone "https://gerrit.opencord.org/sdfabric-helm-charts"
          cd ../aether-in-a-box
          yq -i '.5g-control-plane.images |= {"smf": "5gc-smf:0.0.1-dev"}' sd-core-5g-values.yaml
          #sed -i 's/= rke2/= kubespray/' Makefile
          make 5g-test
          curl -LO "https://dl.k8s.io/release/$(KUBECTL_VERSION)/bin/linux/amd64/kubectl"
          sudo chmod +x kubectl
          sudo mv kubectl /usr/local/bin/
          kubectl get pods --all-namespaces
          make clean
